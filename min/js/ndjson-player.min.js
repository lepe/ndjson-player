/**
 * Author : A.Lepe (dev@alepe.com)
 * License: MIT
 * Version: 0.1.8
 * Updated: 2024-12-10
 * Content: ndjson-player.min.js (Minimized)
 */

class NdJsonPlayer{loop;autoplay;playing=!1;loaded=!1;started=!1;onStart;onLoad;onRender;onPlay;onStop;onFinish;onError;wrapper=null;canvas=null;ctx=null;timer=null;src="";frame=0;multiplier=1;_frames=[];_renderItems=[];_aspectRatio=0;_general={numFrames:0,totTime:0,frameBase:"",thumbBase:"",startTimeStamp:0,keepAspectRatio:!0,framesPerSec:24,fontFamily:"",fontSize:20,fontColor:"yellow",totalTime:"00:01:00",scale:1e3,zIndex:0};constructor(e,t,s,a){const i=this;i.src=e,window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame);const r=()=>{};a=Object.assign({},a),i.onStart=a.onstart||r,i.onLoad=a.onload||r,i.onRender=a.onrender||r,i.onPlay=a.onplay||r,i.onStop=a.onstop||r,i.onFinish=a.onfinish||r,i.onError=a.onerror||(e=>{console.log(e)});let n=null;if(t instanceof Node)n=t;else{if("object"==typeof t)s=t,t="canvas";else if("string"!=typeof t)throw"Incorrect parameter passed to constructor of NdJsonPlayer";n=document.querySelector(t||"canvas")}if(!n)throw"Canvas element was not found in DOM: "+t;{let e=null;if("CANVAS"===n.tagName){e=n;const t=document.createElement("div");n.parentNode.insertBefore(t,n),t.prepend(n),n=t}else if(n.hasChildNodes()){if(e=n.querySelector("canvas"),!e)throw"No canvas found in element"}else e=document.createElement("CANVAS"),n.prepend(e);i.canvas="OffscreenCanvas"in window?e.transferControlToOffscreen():e}i.wrapper=n,i.canvas.width=i.wrapper.parent().clientWidth,i.canvas.height=i.wrapper.parent().clientHeight,i._aspectRatio=i.canvas.height/i.canvas.width,n.classList.add("ndjp"),i.ctx=i.canvas.getContext("2d"),i.fps=s.fps||24,i.loop=s.loop||!1,i.autoplay=s.autoplay||!1,i.showfirst=!1!==s.showfirst,i.path=s.path||"","auto"===s.width&&(s.width=0),"auto"===s.height&&(s.height=0),i.timer=new TimerSrc(1e3/i.fps),i.src&&i.autoplay?i.load():console.log("Initializing without source...")}_reset(){this._frames=[],this.loaded=!1}load(e,t){const s=this;void 0!==t&&(this.src=t,this._reset());let a=!0;!async function(e,t){const s=(await fetch(e)).body.getReader(),a=new TextDecoder;let i="",r=!1;for(;!r;){const{value:e,done:n}=await s.read();let o;for(r=n,i+=a.decode(e,{stream:!0});-1!==(o=i.indexOf("\n"));){t(i.slice(0,o)),i=i.slice(o+1)}}}(this.src,(e=>{a||s.autoplay?(s.processFrame(JSON.parse(e),!0),a=!1):s.append(JSON.parse(e))}))}reload(e,t){const s=this,a=[];switch(s._reset(),!0){case"string"==typeof e:a=e.split(/[\r\n](?=.)/.map(JSON.parse));break;case Array.isArray(e):a=e;break;case"Object"===e.constructor.name:a.push(e);break;default:return void console.log("Unable to reload frames. ")}a.forEach((e=>{s.processFrame(e),t&&t(e)}))}append(e){this._frames.push(e)}prepend(e){this._frames.unshift(e),this.frame++}processFrame(e,t){const s=this,a=s.canvas,i=s.ctx;switch(e.i){case"g":void 0!==e.lp&&(s.loop=!0),void 0!==e.w&&(s.canvas.width=e.w,null==e.sc&&(s._general.scale=e.w),s._aspectRatio=s.canvas.height/s.canvas.width),void 0!==e.h&&(s.canvas.height=e.h,s._aspectRatio=s.canvas.height/s.canvas.width),void 0!==e.kar&&(s._general.keepAspectRatio=e.kar),void 0!==e.sc&&(s._general.scale=e.sc),void 0!==e.fps&&(s._general.framesPerSec=e.fps),void 0!==e.fb&&(s._general.frameBase=e.fb),void 0!==e.thb&&(s._general.thumbBase=e.thb),void 0!==e.tf&&(s._general.numFrames=e.tf),void 0!==e.tt&&(s._general.totTime=e.tt),void 0!==e.ts&&(s._general.startTimeStamp||(s._general.startTimeStamp=e.ts)),void 0!==e.fs&&(s._general.fontSize=e.fs),void 0!==e.fc&&(s._general.fontColor=e.fc),void 0!==e.ff&&(s._general.fontFamily=e.ff);break;case"c":void 0!==e.f||console.log("Circle object didn't specify what?: "+e);break;case"q":case"a":break;case"t":if(void 0!==e.f){const r=a.width/(e.sc||s._general.scale);i.font=(e.fs||s._general.fontSize)*r+"px "+(e.ff||s._general.fontFamily),i.fillStyle=e.fc||s._general.fontColor,i.fillText(e.f,e.x*r||0,e.y*r||0),t&&-1==s._renderItems.indexOf(e.f)&&s._renderItems.push(e)}else console.log("Text object didn't specify content: "+e);break;case"p":if(void 0!==e.f){const r=!!e.tl,n=!!e.fh,o=!!e.fv,h=a.width,l=new Image;l.src=e.f,l.onload=()=>{e.a?function(t,a){const l=h/(e.sc||s._general.scale),c=(1*e.w||t.width)*l,d=(1*e.h||t.height)*l,f=Math.round(c/2),m=Math.round(d/2),p=document.createElement("canvas"),u=p.getContext("2d"),g=1.45*Math.max(c,d),w=Math.round((g-c)/2),_=Math.round((g-d)/2);p.width=g,p.height=g;const v=Math.round(g/2),y=a*Math.PI/180;u.translate(v,v),u.rotate(y),n&&u.scale(-1,1),o&&u.scale(1,-1),u.drawImage(t,-f,-m,c,d);const S=e.x*l-(r?w:v),b=e.y*l-(r?_:v);i.drawImage(p,S,b,g,g)}(l,1*e.a):i.drawImage(l,1*e.x,1*e.y,1*e.w,1*e.h),t&&-1==s._renderItems.indexOf(e.f)&&s._renderItems.push(e)}}else console.log("Picture object didn't specify source: "+e);break;case"f":void 0!==e.f?(s._frames.push(e),s.loaded||(s.loaded=!0,s.autoplay?s.play():s.showfirst&&s.step())):console.log("Picture object didn't specify source: "+e);break;case"v":if(void 0!==e.f){const t=document.createElement("video"),r=document.createElement("source");void 0!==e.w&&(t.width=1*e.w),void 0!==e.h&&(t.height=1*e.h),t.muted=!0,t.appendChild(r),r.src=e.f,t.addEventListener("play",(function(){const e=this;let t=0;const r=1e3/s._general.framesPerSec;!function n(){if(!e.paused&&!e.ended){t+=r;const o=a.width/e.videoWidth,h=a.height/e.videoHeight,l=Math.min(o,h),c=(a.width-e.videoWidth*l)/2,d=(a.height-e.videoHeight*l)/2;s._general.keepAspectRatio&&(a.height=a.width*s._aspectRatio),i.clearRect(0,0,a.width,a.height),i.drawImage(e,0,0,e.videoWidth,e.videoHeight,c,d,e.videoWidth*l,e.videoHeight*l),i.font="15px Arial",i.fillStyle="white",i.fillText(Math.round(t),50,50),s._renderItems.length&&s._renderItems.forEach((e=>{if(e.t){const a=s._timeToMilliSeconds(e.t),i=e.tt?a+s._timeToMilliSeconds(e.tt):s._general.totTime||9999999999999;t>=a&&t<=i&&s.processFrame(e,!1)}else s.processFrame(e,!1)})),setTimeout(n,r)}}()}),0),t.play(),s.loop&&(t.onended=()=>t.play())}else console.log("Video object didn't specify source: "+e);break;case"d":s.onRender(e)}s.started||(s.onStart(s),s.started=!0)}_render(e){if(null==this.timer)throw"TimerSrc was not initialized";if(0===this._frames.length)throw"Video is empty or no frames were found";this.frame>=this._frames.length-1&&(this.frame=this.loop?0:this._frames.length-1),this.frame<0&&(this.frame=this.loop?this._frames.length-1:0),this._displayImg(e)}_displayImg(e){const t=this;let s=t._frames[t.frame];if(s){const a=function(){t.onRender(s),t.timer.call((function(){t._increment(),e||t.timer.nocall(),t._displayImg()}))};if(void 0!==s.f){const e=t._general.frameBase+s.f;t._image(e,a)}else a()}}_increment(){this.frame+=1*this.multiplier,this.frame<0&&(this.loop?this.frame=this._frames.length-1:(this.frame=0,this.pause(),this.onFinish(this))),this.frame>this.totalFrames()-1&&(this.loop?this.frame=0:(this.frame=this._frames.length-1,this.pause(),this.onFinish(this)))}_draw=function(e,t){const s=this;return 0===e.width&&0===e.height?(e.onerror(),void 0!==t&&t(!1)):(s.ctx.clearRect(0,0,s.canvas.width,s.canvas.height),s.ctx.drawImage(e,0,0,e.width,e.height,0,0,s.canvas.width,s.canvas.height),void 0!==t&&t(!0)),this};_image=function(e,t){const s=this,a=new Image;return a.crossOrigin="",a.onload=function(){s._draw(a,(function(e){e&&void 0!==t&&t(a)}))},a.onerror=function(){const e=s.onError();e&&(a.src=e)},a.src="/"===e[0]||e.match(/^https?:/)||e.match(/^data:image/)?e:s.path+e,this};_timeToMilliSeconds(e){let t=0;return-1!==e.indexOf(".")&&(t=1*e.split(".")[1],e=e.split(".")[0]),1e3*(-1!==e.indexOf(":")?e.split(":").reduce(((e,t,s)=>e+t*Math.pow(60,2-s)),0):0)+t}frameBase(){return this._general.frameBase}thumbBase(){return this._general.thumbBase}currentFrame(){return this.frame}totalFrames(){return this._numFrames||this._frames.length}totalTime(){return this._totTime||this.currentFrame()/this.fps}frameAt(e){const t=this;let s=e<this.totalFrames()?t._frames[e]:null;return s&&(s.fb=t._general.frameBase),s}indexAt(e){return~~(e*this.totalFrames()/100)}playerNode(){return this.wrapper}play(e){e<0?e=0:e>this._frames.length?e=this._frames.length-1:void 0!==e&&(this.frame=1*e),this.playing=!0,this.timer.play(),this._render(!1),this.onPlay(this)}playForward(e){this.play(e)}pause(){this.playing=!1,this.timer.pause(),this.onStop(this)}stop(){this.playing=!1,this.frame=0,this.timer.pause(),this._displayImg(!0),this.onStop(this)}step(){this.onPlay(this),this.playing=!1,this.timer.step(),this._render(!0),this.onStop(this)}jumpTo(e){e<0?e=0:e>this._frames.length?e=this._frames.length-1:void 0!==e&&(this.frame=1*e),this._render(!0)}stepForwards(){this.step()}reset(){return void 0!==this.ctx.reset&&(this.ctx.reset(),this.ctx.clear(),this.stop(),this.canvas.width=this.canvas.width),this}}
//# sourceMappingURL=ndjson-player.min.js.map
